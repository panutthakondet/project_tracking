@model IEnumerable<ProjectTracking.Models.PhaseAssign>
@using System.Globalization

@{
    ViewData["Title"] = "Assigned Employees";
    var th = new CultureInfo("th-TH");

    var empColorMap = new Dictionary<int, string>();
    var pastelColors = new[]
    {
        "#f8f9fa",
        "#e9f5ff",
        "#eafaf1",
        "#fff4e6",
        "#f3e8ff",
        "#e7f1ff",
        "#fef7e0"
    };
    var colorIndex = 0;
}

@functions {
    private static string? ReadNestedString(object? obj, params string[] path)
    {
        if (obj == null) return null;
        object? cur = obj;
        foreach (var seg in path)
        {
            if (cur == null) return null;
            var t = cur.GetType();
            var p = t.GetProperty(seg);
            if (p == null) return null;
            cur = p.GetValue(cur);
        }
        return cur?.ToString();
    }

    private static int? ReadNestedInt(object? obj, params string[] path)
    {
        var s = ReadNestedString(obj, path);
        if (string.IsNullOrWhiteSpace(s)) return null;
        return int.TryParse(s, out var v) ? v : (int?)null;
    }

    private static string GetPhaseNameSafe(object a)
    {
        var v = ReadNestedString(a, "ProjectPhase", "PhaseName")
             ?? ReadNestedString(a, "Phase", "PhaseName")
             ?? ReadNestedString(a, "ProjectPhase", "phase_name")
             ?? ReadNestedString(a, "Phase", "phase_name")
             ?? ReadNestedString(a, "PhaseName")
             ?? ReadNestedString(a, "phase_name");

        return string.IsNullOrWhiteSpace(v) ? "-" : v!;
    }
}

<style>
.table-hover tbody tr:hover > * { background-color: inherit !important; }
.table tbody tr > td { background-color: inherit !important; }

.sticky-col { position: sticky; z-index: 3; background-clip: padding-box; }
.sticky-1 { left: 0; width:70px; min-width:70px; max-width:70px; }
.sticky-2 { left: 70px; width:280px; min-width:280px; max-width:280px; }

thead .sticky-col { z-index: 5; }

.table-assign { table-layout: fixed; }
.table-assign th, .table-assign td { vertical-align: middle; }
.table-assign .col-phase { width:240px; }
.table-assign .col-role { width:220px; }
.table-assign .col-period { width:280px; white-space: nowrap; }
.table-assign .col-remark { width:360px; }
.table-assign .col-action { width:190px; }

.table-assign td { word-break: break-word; }
.table-assign .nowrap { white-space: nowrap; }

.dragging-row { opacity: .65; }
.sortable-ghost { opacity: .35; }
.drag-handle { font-weight: 700; }
</style>

<div class="mb-3">
    <h2 class="fw-bold">üë• Assigned Employees</h2>
    <p class="text-muted mb-0">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Assign) ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</p>
</div>

<form method="get" class="row g-3 mb-4" id="filterForm">
    <div class="col-md-4">
        <label class="form-label fw-bold">üìÅ Project</label>
        <select name="projectId" id="projectSelect" class="form-select">
            <option value="">-- Select Project --</option>
            @foreach (var p in ViewBag.Projects)
            {
                if (ViewBag.SelectedProject?.ProjectId == p.ProjectId)
                {
                    <option value="@p.ProjectId" selected>@p.ProjectName</option>
                }
                else
                {
                    <option value="@p.ProjectId">@p.ProjectName</option>
                }
            }
        </select>
    </div>

    <div class="col-md-4">
        <label class="form-label fw-bold">üë§ Employee</label>
        <select name="empId" id="empSelect" class="form-select" @(ViewBag.SelectedProject == null ? "disabled" : "")>
            <option value="">-- All Employees --</option>
            @foreach (var e in ViewBag.EmployeeList)
            {
                if (ViewBag.SelectedEmpId == e.EmpId)
                {
                    <option value="@e.EmpId" selected>@e.EmpName</option>
                }
                else
                {
                    <option value="@e.EmpId">@e.EmpName</option>
                }
            }
        </select>
    </div>
</form>

@if (ViewBag.SelectedProject != null)
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold mb-0">üìå Project : @ViewBag.SelectedProject.ProjectName</h4>
        <a asp-action="Create" asp-route-projectId="@ViewBag.SelectedProject.ProjectId" class="btn btn-primary">‚ûï Add Assign</a>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle table-assign" style="min-width:1500px;">
            <colgroup>
                <col style="width:70px;" />
                <col style="width:280px;" />
                <col class="col-phase" />
                <col class="col-role" />
                <col class="col-period" />
                <col class="col-period" />
                <col class="col-remark" />
                <col class="col-action" />
            </colgroup>
            <thead class="table-dark text-center">
                <tr>
                    <th class="sticky-col sticky-1">‚Üï No.</th>
                    <th class="sticky-col sticky-2">Employee</th>
                    <th class="col-phase">Phase</th>
                    <th class="col-role">Role</th>
                    <th class="col-period">Plan Period</th>
                    <th class="col-period">Actual Period</th>
                    <th class="col-remark">Remark</th>
                    <th class="col-action">Action</th>
                </tr>
            </thead>
            @if (!Model.Any())
            {
                <tbody>
                    <tr><td colspan="8" class="text-center text-muted py-4">‚Äî No assignment ‚Äî</td></tr>
                </tbody>
            }
            else
            {
                var row = 1;

                // ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô tbody ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß (‡∏£‡∏ß‡∏°‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢) ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡∏à‡∏≤‡∏Å phase_sort
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å phase_sort (‡πÉ‡∏ô phase_assign) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ï‡∏≤‡∏° phase_order ‡∏Ç‡∏≠‡∏á project_phase ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏° assign_id
                var ordered = Model
                    .OrderBy(a => a.PhaseSort ?? int.MaxValue)
                    .ThenBy(a => ReadNestedInt(a, "ProjectPhase", "PhaseOrder")
                              ?? ReadNestedInt(a, "Phase", "PhaseOrder")
                              ?? ReadNestedInt(a, "PhaseOrder")
                              ?? int.MaxValue)
                    .ThenBy(a => a.AssignId);

                <tbody id="assign-tbody">
                @foreach (var a in ordered)
                {
                    if (!empColorMap.ContainsKey(a.EmpId))
                    {
                        empColorMap[a.EmpId] = pastelColors[colorIndex % pastelColors.Length];
                        colorIndex++;
                    }
                    var bg = empColorMap[a.EmpId];

                    <tr style="background-color:@bg;" data-assign-id="@a.AssignId">
                        <td class="text-center fw-semibold sticky-col sticky-1">
                            <span class="drag-handle" title="‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß" style="cursor:grab; user-select:none;">‚ò∞</span>
                            <span class="ms-2">@row</span>
                        </td>
                        <td class="fw-semibold sticky-col sticky-2">üë§ @a.Employee?.EmpName</td>
                        <td class="fw-semibold">@GetPhaseNameSafe(a)</td>
                        <td>@a.Role</td>
                        <td class="text-center nowrap">
                            @(a.PlanStart?.ToString("dd MMM yyyy", th) ?? "-") <span class="mx-1">‚Äì</span> @(a.PlanEnd?.ToString("dd MMM yyyy", th) ?? "-")
                        </td>
                        <td class="text-center nowrap">
                            @(a.ActualStart?.ToString("dd MMM yyyy", th) ?? "-") <span class="mx-1">‚Äì</span> @(a.ActualEnd?.ToString("dd MMM yyyy", th) ?? "-")
                        </td>
                        <td class="col-remark">@a.Remark</td>
                        <td class="text-center">
                            <a asp-action="Edit" asp-route-id="@a.AssignId" class="btn btn-sm btn-outline-primary me-1">‚úèÔ∏è Edit</a>
                            <form asp-action="Delete" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@a.AssignId" />
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Assign ‡∏ô‡∏µ‡πâ?');">üóë Delete</button>
                            </form>
                        </td>
                    </tr>
                    row++;
                }
                </tbody>
            }
        </table>
    </div>
}
else
{
    <div class="alert alert-secondary mt-3">‚¨Ü ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Project ‡∏Å‡πà‡∏≠‡∏ô</div>
}

<form id="antiForgeryForm" method="post" style="display:none;">@Html.AntiForgeryToken()</form>

@section Scripts{
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
$(function () {
    const $form = $('#filterForm');
    const hasProject = @(ViewBag.SelectedProject != null ? "true" : "false");

    if (!window.jQuery || !$.fn || !$.fn.select2) {
        console.error('Select2 ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö _Layout.cshtml ‡∏ß‡πà‡∏≤‡∏°‡∏µ jquery + select2.js ‡πÅ‡∏•‡∏∞‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)');
        return;
    }

    $('#projectSelect').select2({ placeholder: "-- Select Project --", allowClear: true, width: '100%', minimumResultsForSearch: 0, dropdownParent: $(document.body) });

    if (!hasProject) {
        $('#empSelect').prop('disabled', true);
    } else {
        $('#empSelect').select2({ placeholder: "-- All Employees --", allowClear: true, width: '100%', minimumResultsForSearch: 0, dropdownParent: $(document.body) });
    }

    function submitSafely() { setTimeout(function () { $form.trigger('submit'); }, 0); }
    $('#projectSelect').on('select2:select select2:clear', function () { submitSafely(); });
    $('#empSelect').on('select2:select select2:clear', function () { if (hasProject) submitSafely(); });
});
</script>

<script>
(function () {
    const tbody = document.getElementById('assign-tbody');
    if (!tbody) return;

    const tokenEl = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]');
    const antiForgeryToken = tokenEl ? tokenEl.value : null;

    function refreshRowNumbers() {
        const rows = Array.from(document.querySelectorAll('tr[data-assign-id]'));
        let i = 1;
        for (const r of rows) {
            const noCell = r.querySelector('td.sticky-1');
            if (!noCell) continue;
            const spanNo = noCell.querySelector('span.ms-2');
            if (spanNo) spanNo.textContent = String(i);
            i++;
        }
    }

    function collectAssignIds() {
        const rows = Array.from(tbody.querySelectorAll('tr[data-assign-id]'));
        return rows
            .map(r => parseInt(r.getAttribute('data-assign-id') || '0', 10))
            .filter(x => Number.isFinite(x) && x > 0);
    }

    async function saveReorder() {
        const assignIds = collectAssignIds();
        if (!assignIds || assignIds.length === 0) {
            console.error('Reorder failed: empty assignIds');
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Reorder)\n‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ assignIds (‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏ñ‡∏ß)');
            return false;
        }

        // ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON array ‡∏ï‡∏£‡∏á ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ ModelBinder ‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà Controller ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô int[]/List<int>
        const payload = assignIds;

        const headers = { 'Content-Type': 'application/json' };
        if (antiForgeryToken) headers['RequestVerificationToken'] = antiForgeryToken;

        const selectedProjectId = @((int?)ViewBag.SelectedProjectId ?? 0);
        const reorderUrl = '@Url.Action("Reorder", "PhaseAssigns")' + '?projectId=' + selectedProjectId;

        const res = await fetch(reorderUrl, {
            method: 'POST',
            headers,
            body: JSON.stringify(payload)
        });

        const txt = await res.text();
        if (!res.ok) {
            console.error('Reorder failed:', txt, payload);
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Reorder)\n' + (txt || 'Bad Request') + '\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ PhaseAssignsController.Reorder');
            return false;
        }

        if (txt) console.log('Reorder OK:', txt);
        return true;
    }

    Sortable.create(tbody, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'sortable-ghost',
        chosenClass: 'dragging-row',
        // ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢/‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
        forceFallback: true,
        fallbackTolerance: 5,
        scroll: true,
        scrollSensitivity: 60,
        scrollSpeed: 15,
        onEnd: async function () {
            refreshRowNumbers();
            const ok = await saveReorder();
            if (!ok) {
                refreshRowNumbers();
                return;
            }
            refreshRowNumbers();
        }
    });

    refreshRowNumbers();
})();
</script>
}