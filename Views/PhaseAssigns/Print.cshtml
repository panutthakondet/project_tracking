@model IEnumerable<ProjectTracking.Models.PhaseAssign>
@using System.Globalization

@{
    ViewData["Title"] = "Assigned Employees Report";
    var th = new CultureInfo("th-TH");

    // =========================================
    // üé® ‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥ Employee (‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å EmpId)
    // =========================================
    string GetColorByEmpId(int empId)
    {
        var r = (empId * 70) % 256;
        var g = (empId * 130) % 256;
        var b = (empId * 200) % 256;

        r = (r + 200) / 2;
        g = (g + 200) / 2;
        b = (b + 200) / 2;

        return $"rgb({r},{g},{b})";
    }
}

<!-- ================= FILTER (NO PRINT) ================= -->
<form method="get" class="row g-3 mb-4 no-print">

    <!-- PROJECT -->
    <div class="col-md-3">
        <label class="form-label fw-bold">üìÅ Project</label>
        <select name="projectId"
                class="form-select"
                onchange="this.form.submit()">
            <option value="">-- Select Project --</option>
            @foreach (var p in ViewBag.Projects)
            {
                <option value="@p.ProjectId"
                        selected="@(ViewBag.SelectedProjectId == p.ProjectId)">
                    @p.ProjectName
                </option>
            }
        </select>
    </div>

    <!-- EMPLOYEE -->
    <div class="col-md-3">
        <label class="form-label fw-bold">üë§ Employee</label>
        <select name="empId"
                class="form-select"
                onchange="this.form.submit()">
            <option value="">-- All Employees --</option>
            @foreach (var e in ViewBag.EmployeeList)
            {
                <option value="@e.EmpId"
                        selected="@(ViewBag.SelectedEmpId == e.EmpId)">
                    @e.EmpName
                </option>
            }
        </select>
    </div>

    <!-- ROLE -->
    <div class="col-md-3">
        <label class="form-label fw-bold">üß© Role</label>
        <select name="role"
                class="form-select"
                onchange="this.form.submit()">
            <option value="">-- All Roles --</option>
            @foreach (var r in ViewBag.RoleList ?? new List<string>())
            {
                <option value="@r"
                        selected="@(ViewBag.SelectedRole == r)">
                    @r
                </option>
            }
        </select>
    </div>

    <!-- PRINT BUTTONS -->
    <div class="col-md-3 align-self-end text-end">
        <div class="d-flex justify-content-end gap-2">

            <!-- üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°) -->
            <button type="button"
                    class="btn btn-dark"
                    onclick="window.print()">
                üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            </button>

            <!-- üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà / ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°) -->
            @if (Model.Any())
            {
                <a asp-action="Form"
                   asp-route-id="@Model.First().AssignId"
                   target="_blank"
                   class="btn btn-outline-primary">
                    üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
                </a>
            }

        </div>
    </div>
</form>

<!-- ================= REPORT HEADER ================= -->
<div class="text-center mb-4">
    <h2 class="fw-bold">üë• Assigned Employees Report</h2>
    <div class="text-muted">
        <b>Project:</b> @(ViewBag.SelectedProject?.ProjectName ?? "All") <br />
        <b>Print Date:</b> @DateTime.Now.ToString("dd MMM yyyy HH:mm", th)
    </div>
</div>

<!-- ================= TABLE ================= -->
<div class="table-responsive">
    <table class="table table-bordered table-sm align-middle">
        <thead class="table-light text-center">
            <tr>
                <th style="width:220px;">Employee</th>
                <th>Role</th>
                <th style="width:220px;">Plan Period</th>
                <th style="width:220px;">Actual Period</th>
                <th style="width:260px;">Remark</th>
            </tr>
        </thead>

        <tbody>
        @if (!Model.Any())
        {
            <tr>
                <td colspan="5"
                    class="text-center text-muted py-4">
                    ‚Äî No assignment ‚Äî
                </td>
            </tr>
        }
        else
        {
            foreach (var a in Model)
            {
                var bg = GetColorByEmpId(a.EmpId);

                <tr>
                    <td style="background-color:@bg !important;">
                        @a.Employee?.EmpName
                    </td>

                    <td style="background-color:@bg !important; white-space:normal;">
                        @a.Role
                    </td>

                    <td style="background-color:@bg !important;" class="text-center">
                        @(a.PlanStart?.ToString("dd MMM yyyy", th) ?? "-")
                        ‚Äì
                        @(a.PlanEnd?.ToString("dd MMM yyyy", th) ?? "-")
                    </td>

                    <td style="background-color:@bg !important;" class="text-center">
                        @(a.ActualStart?.ToString("dd MMM yyyy", th) ?? "-")
                        ‚Äì
                        @(a.ActualEnd?.ToString("dd MMM yyyy", th) ?? "-")
                    </td>

                    <td style="background-color:@bg !important;">
                        @a.Remark
                    </td>
                </tr>
            }
        }
        </tbody>
    </table>
</div>

<!-- ================= PRINT STYLE ================= -->
<style>
@@media print {
    .no-print {
        display: none !important;
    }

    body {
        font-size: 12px;
    }

    table {
        page-break-inside: auto;
    }

    tr {
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group;
    }
}
</style>