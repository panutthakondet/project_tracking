@model ProjectTracking.Models.PhaseAssign

@{
    ViewData["Title"] = "Assign Employee";
}

<div class="mb-4">
    <h2 class="fw-bold">‚ûï Assign Employee</h2>
    <p class="text-muted mb-0">
        ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Phase ‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
    </p>
</div>

<div class="card shadow-sm">
    <div class="card-body">

        <form asp-action="Create"
              method="post"
              onsubmit="return confirm('Assign Employee ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');">

            @Html.AntiForgeryToken()

            <input type="hidden" name="projectId" value="@ViewBag.ProjectId" />

            <!-- ‡∏™‡πà‡∏á Role ‡∏Å‡∏•‡∏±‡∏ö Controller -->
            <input asp-for="Role" type="hidden" id="roleHidden" />

            <div class="row g-3">

                <!-- EMPLOYEE -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">üë§ Employee</label>
                    <select asp-for="EmpId" asp-items="ViewBag.Employees" class="form-select" required>
                        <option value="">-- Select Employee --</option>
                    </select>
                    <span asp-validation-for="EmpId" class="text-danger"></span>
                </div>

                <!-- PHASE -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">üß© Phase</label>
                    <select asp-for="PhaseId"
                            class="form-select"
                            required
                            id="phaseSelect">
                        <option value="" selected>-- Select Phase --</option>

                        @* ‡πÉ‡∏ä‡πâ PhaseItems (‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Controller) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà data-* ‡πÉ‡∏´‡πâ JS ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ *@
                        @if (ViewBag.PhaseItems != null)
                        {
                            foreach (var ph in ViewBag.PhaseItems)
                            {
                                var ps = ph.PlanStart == null ? "" : ((DateTime)ph.PlanStart).ToString("yyyy-MM-dd");
                                var pe = ph.PlanEnd == null ? "" : ((DateTime)ph.PlanEnd).ToString("yyyy-MM-dd");
                                <option value="@ph.PhaseId"
                                        data-role="@ph.PhaseName"
                                        data-plan-start="@ps"
                                        data-plan-end="@pe">
                                    @ph.PhaseName
                                </option>
                            }
                        }
                        else
                        {
                            @* fallback ‡∏ñ‡πâ‡∏≤ Controller ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á PhaseItems *@
                            @if (ViewBag.Phases != null)
                            {
                                foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Phases)
                                {
                                    <option value="@item.Value" selected="@item.Selected">@item.Text</option>
                                }
                            }
                        }
                    </select>
                </div>

                <!-- ROLE SHOW -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">üéØ Role (Auto)</label>
                    <input type="text" class="form-control" id="roleDisplay" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ Role" />
                </div>

                <!-- PLAN START -->
                <div class="col-md-3">
                    <label class="form-label fw-semibold">üìÖ Plan Start</label>
                    <input asp-for="PlanStart" type="date" class="form-control" id="planStart" />
                </div>

                <!-- PLAN END -->
                <div class="col-md-3">
                    <label class="form-label fw-semibold">üìÖ Plan End</label>
                    <input asp-for="PlanEnd" type="date" class="form-control" id="planEnd" />
                </div>

                <!-- REMARK -->
                <div class="col-md-12">
                    <label class="form-label fw-semibold">üìù Remark</label>
                    <textarea asp-for="Remark" class="form-control" rows="3"></textarea>
                </div>

            </div>

            <div class="mt-4 d-flex gap-2">
                <button type="submit" class="btn btn-primary">üíæ Save Assign</button>
                <a asp-action="Index" asp-route-projectId="@ViewBag.ProjectId" class="btn btn-outline-secondary">‚Ü© Back</a>
            </div>

        </form>
    </div>
</div>

<script>
(function () {
    function onReady(fn) {
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", fn);
        } else {
            fn();
        }
    }

    function findOptionByValue(selectEl, value) {
        if (!selectEl) return null;
        if (value == null) return null;
        // ‡πÉ‡∏ä‡πâ CSS.escape ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ value ‡∏°‡∏µ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©
        const esc = (window.CSS && CSS.escape) ? CSS.escape(String(value)) : String(value).replace(/"/g, '\\"');
        return selectEl.querySelector('option[value="' + esc + '"]');
    }

    onReady(function () {
        const phaseSelect = document.getElementById("phaseSelect");
        const planStart = document.getElementById("planStart");
        const planEnd = document.getElementById("planEnd");
        const roleHidden = document.getElementById("roleHidden");
        const roleDisplay = document.getElementById("roleDisplay");

        // ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Role ‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞ sync ‡πÑ‡∏õ‡∏¢‡∏±‡∏á hidden input (Role) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Controller
        if (roleDisplay && roleHidden && !roleDisplay.dataset.roleBound) {
            roleDisplay.dataset.roleBound = "1";
            roleDisplay.addEventListener("input", function () {
                roleHidden.value = (roleDisplay.value || "").toString();
            });
        }

        if (!phaseSelect) return;

        // force default empty selection
        phaseSelect.selectedIndex = 0;
        clearTimeout(window.__phaseInit);
        window.__phaseInit = setTimeout(() => {
            phaseSelect.value = "";
        }, 0);

        function clearAll() {
            if (planStart) planStart.value = "";
            if (planEnd) planEnd.value = "";
            if (roleHidden) roleHidden.value = "";
            if (roleDisplay) roleDisplay.value = "";
        }

        function applyFromValue(value) {
            const opt = findOptionByValue(phaseSelect, value) || phaseSelect.options[phaseSelect.selectedIndex];

            if (!opt || !opt.value) {
                clearAll();
                return;
            }

            // role = phase name (‡∏ï‡∏≤‡∏° requirement)
            const role = (opt.dataset.role || opt.text || "").toString().trim();

            // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô yyyy-MM-dd ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà input[type=date]
            const ps = (opt.dataset.planStart || "").toString().trim();
            const pe = (opt.dataset.planEnd || "").toString().trim();

            if (roleHidden) roleHidden.value = role;
            if (roleDisplay) roleDisplay.value = role;

            if (planStart) planStart.value = ps;
            if (planEnd) planEnd.value = pe;
        }

        function applyFromSelectedOption() {
            applyFromValue(phaseSelect.value);
        }

        // ‡∏Å‡∏±‡∏ô‡∏ú‡∏π‡∏Å event ‡∏ã‡πâ‡∏≥
        if (!phaseSelect.dataset.phasePlanBound) {
            phaseSelect.dataset.phasePlanBound = "1";

            // native change
            phaseSelect.addEventListener("change", applyFromSelectedOption);

            // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Select2 (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
            if (window.jQuery && window.jQuery.fn && window.jQuery.fn.select2) {
                window.jQuery(phaseSelect)
                    .on("select2:select", function (e) {
                        applyFromValue(e.params && e.params.data ? e.params.data.id : phaseSelect.value);
                    })
                    .on("select2:clear", function () {
                        clearAll();
                    })
                    .on("change.select2", function () {
                        applyFromSelectedOption();
                    });
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ PhaseId ‡∏ï‡∏¥‡∏î‡∏°‡∏≤)
        applyFromSelectedOption();
    });
})();
</script>