@using System
@using System.Linq
@using System.Collections.Generic

@{
    ViewData["Title"] = "Menu Permissions";

    var username = (ViewBag.Username as string ?? "").Trim();
    var allMenus = ViewBag.AllMenus as List<(string Key, string Label)> ?? new List<(string, string)>();
    var selected = ViewBag.SelectedMenus as HashSet<string> ?? new HashSet<string>(StringComparer.OrdinalIgnoreCase);
}

@{
    // ‚úÖ Lookup menu by key
    var menuMap = allMenus.ToDictionary(x => x.Key, x => x.Label, StringComparer.OrdinalIgnoreCase);

    // ‚úÖ Group definitions (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Home)
    var groupProject = new List<string>
    {
        "UserManagement.Index",
        "Employees.Index",
        "Projects.Index",
        "ProjectPhases.Index",
        "PhaseAssigns.Index",
        "ProjectIssues.Index",
        "ProjectIssues.DevIndex",
        "Meetings.Index",
    };

    var groupReport = new List<string>
    {
        "Projects.ViewOnly",
        "ProjectIssues.ViewOnly",
        "PhaseAssigns.Print",
        "PhaseStatusReport.Index",
        "PhaseStatusReport.Timeline",
        "Dashboard.Workload",
        "IssueDashboard.Index",
    };

    var groupSetting = new List<string>
    {
        "UserManagement.Permissions",
    };

    // ‚úÖ Helper to render only keys that exist in allMenus (‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏∏‡∏î)
    List<(string Key, string Label)> BuildGroup(List<string> keys)
    {
        var list = new List<(string, string)>();
        foreach (var k in keys)
        {
            if (menuMap.TryGetValue(k, out var label))
                list.Add((k, label));
        }
        return list;
    }

    var g1 = BuildGroup(groupProject);
    var g2 = BuildGroup(groupReport);
    var g3 = BuildGroup(groupSetting);

    // ‚úÖ Uncategorized (‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°)
    var used = new HashSet<string>(g1.Select(x => x.Key), StringComparer.OrdinalIgnoreCase);
    foreach (var x in g2) used.Add(x.Key);
    foreach (var x in g3) used.Add(x.Key);

    var gOther = allMenus.Where(x => !used.Contains(x.Key)).ToList();
}

<style>
    .card-soft{
        border:0;
        border-radius:16px;
        box-shadow:0 10px 28px rgba(0,0,0,.08);
        overflow:hidden;
    }
    .card-soft .card-body{ padding:18px; }

    .menu-grid{
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap:10px;
    }

    .menu-item{
        border:1px solid #e5e7eb;
        border-radius:14px;
        padding:12px 12px;
        display:flex;
        gap:10px;
        align-items:flex-start;
        background:#fff;
    }
    .menu-item:hover{ background:#f8fafc; }

    .group-title{
        font-size:16px;
        font-weight:900;
        margin:10px 0 12px;
        padding-left:12px;
        border-left:6px solid #ff9f43;
    }

    .group-wrap{ margin-bottom:18px; }

    .menu-key{ font-size:12px; color:#64748b; margin-top:2px; }
</style>

<div class="d-flex align-items-start justify-content-between gap-2 mb-3">
    <div>
        <h3 class="fw-bold mb-0">üîê Menu Permissions</h3>
        <div class="text-muted">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ <b>@username</b> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ</div>
    </div>

    <a asp-action="Index" class="btn btn-outline-secondary" style="border-radius:12px;">
        ‚Üê Back
    </a>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success" style="border-radius:12px;">@TempData["Success"]</div>
}

<div class="card card-soft">
    <div class="card-body">
        <form asp-action="Permissions" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="username" value="@username" />

            <!-- üìÅ ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ -->
            @if (g1.Any())
            {
                <div class="group-wrap">
                    <div class="group-title">üìÅ ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
                    <div class="menu-grid">
                        @foreach (var m in g1)
                        {
                            var isChecked = selected.Contains(m.Key);
                            <label class="menu-item">
                                <input type="checkbox" name="menus" value="@m.Key" @(isChecked ? "checked" : null)
                                       style="margin-top:3px;" />
                                <div>
                                    <div class="fw-bold">@m.Label</div>
                                    <div class="menu-key">@m.Key</div>
                                </div>
                            </label>
                        }
                    </div>
                </div>
            }

            <!-- üêû ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô -->
            @if (g2.Any())
            {
                <div class="group-wrap">
                    <div class="group-title">üêû ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</div>
                    <div class="menu-grid">
                        @foreach (var m in g2)
                        {
                            var isChecked = selected.Contains(m.Key);
                            <label class="menu-item">
                                <input type="checkbox" name="menus" value="@m.Key" @(isChecked ? "checked" : null)
                                       style="margin-top:3px;" />
                                <div>
                                    <div class="fw-bold">@m.Label</div>
                                    <div class="menu-key">@m.Key</div>
                                </div>
                            </label>
                        }
                    </div>
                </div>
            }

            <!-- ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö -->
            @if (g3.Any())
            {
                <div class="group-wrap">
                    <div class="group-title">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</div>
                    <div class="menu-grid">
                        @foreach (var m in g3)
                        {
                            var isChecked = selected.Contains(m.Key);
                            <label class="menu-item">
                                <input type="checkbox" name="menus" value="@m.Key" @(isChecked ? "checked" : null)
                                       style="margin-top:3px;" />
                                <div>
                                    <div class="fw-bold">@m.Label</div>
                                    <div class="menu-key">@m.Key</div>
                                </div>
                            </label>
                        }
                    </div>
                </div>
            }

            <!-- üß© ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) -->
            @if (gOther.Any())
            {
                <div class="group-wrap">
                    <div class="group-title">üß© ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</div>
                    <div class="menu-grid">
                        @foreach (var m in gOther)
                        {
                            var isChecked = selected.Contains(m.Key);
                            <label class="menu-item">
                                <input type="checkbox" name="menus" value="@m.Key" @(isChecked ? "checked" : null)
                                       style="margin-top:3px;" />
                                <div>
                                    <div class="fw-bold">@m.Label</div>
                                    <div class="menu-key">@m.Key</div>
                                </div>
                            </label>
                        }
                    </div>
                </div>
            }

            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary" style="border-radius:12px; font-weight:800;">
                    üíæ Save
                </button>
                <a asp-action="Permissions" asp-route-username="@username"
                   class="btn btn-outline-secondary" style="border-radius:12px;">
                    ‚Üª Reload
                </a>
            </div>
        </form>
    </div>
</div>