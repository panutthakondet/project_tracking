@model IEnumerable<ProjectTracking.Models.ProjectIssue>

@{
    ViewData["Title"] = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£";
    var selectedProject = ViewBag.SelectedProject as ProjectTracking.Models.Project;
    var selectedEmp = ViewBag.SelectedEmp as string;
    var empList = ViewBag.EmpList as IEnumerable<string> ?? Enumerable.Empty<string>();
}

<style>
.issue-table-wrapper{ overflow-x:auto; border:1px solid #ddd; border-radius:10px; }
.issue-table{ min-width:1820px; }

.sticky-col{ position:sticky; left:0; background:#fff; z-index:2; }
.sticky-col-2{ position:sticky; left:90px; background:#fff; z-index:2; }

.col-id{ width:90px; min-width:90px; text-align:center; }
.col-issue{ width:360px; min-width:360px; }
.col-owner{ width:180px; min-width:180px; text-align:center; }
.col-status{ width:170px; min-width:170px; text-align:center; }
.col-devstatus{ width:170px; min-width:170px; text-align:center; }
.col-priority{ width:140px; min-width:140px; text-align:center; }
.col-lastfix{ width:180px; min-width:180px; text-align:center; }
.col-images{ min-width:260px; }
.col-fiximages{ min-width:260px; }
.col-action{ width:190px; min-width:190px; text-align:center; }

.reopen-badge{ font-size:11px; padding:3px 7px; border-radius:6px; margin-left:6px; }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="fw-bold mb-0">üêû ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h2>
        <small class="text-muted">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤ / ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á / Bug ‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</small>
    </div>

    @if (selectedProject != null)
    {
        <a asp-action="Create" asp-route-projectId="@selectedProject.ProjectId" class="btn btn-primary">
            ‚ûï Add Issue
        </a>
    }
</div>

<form method="get" id="filterForm" class="row g-3 mb-4">
    <div class="col-md-4">
        <label class="form-label fw-semibold">üìÅ Project</label>
        <select id="projectSelect" name="projectId" class="form-select">
            <option value="">-- Select Project --</option>
            @foreach (var p in ((IEnumerable<ProjectTracking.Models.Project>)ViewBag.Projects ?? Enumerable.Empty<ProjectTracking.Models.Project>())
                                .OrderBy(x => x.EndDate ?? DateTime.MaxValue))
            {
                <option value="@p.ProjectId" selected="@(selectedProject?.ProjectId == p.ProjectId)">
                    @p.ProjectName
                </option>
            }
        </select>
    </div>

    @if (selectedProject != null)
    {
        <div class="col-md-4">
            <label class="form-label fw-semibold">üë§ Owner</label>
            <select name="empName" class="form-select" onchange="document.getElementById('filterForm').submit()">
                <option value="">-- All --</option>
                @foreach (var emp in empList)
                {
                    <option value="@emp" selected="@(emp == selectedEmp)">
                        @emp
                    </option>
                }
            </select>
        </div>
    }
</form>

@if (selectedProject == null)
{
    <div class="alert alert-info">‚¨Ü ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Project ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Issue</div>
}
else
{
    <div class="issue-table-wrapper">
        <table class="table table-bordered table-hover align-middle issue-table">
            <thead class="table-dark text-center">
                <tr>
                    <th class="col-id sticky-col">No.</th>
                    <th class="col-issue sticky-col-2">Issue</th>
                    <th class="col-owner">Owner</th>
                    <th class="col-status">Status</th>
                    <th class="col-devstatus">Dev Status</th>
                    <th class="col-priority">Priority</th>
                    <th class="col-lastfix">Last Fix</th>
                    <th class="col-images">Before</th>
                    <th class="col-fiximages">After</th>
                    <th class="col-action">Action</th>
                </tr>
            </thead>

            <tbody>
            @{
                var row = 1;
            }

            @foreach (var i in Model)
            {
                var urgent = i.IssuePriority == "URGENT";
                var reopenCount = i.ReopenCount;

                string reopenClass =
                    reopenCount == 0 ? "bg-success" :
                    reopenCount == 1 ? "bg-info" :
                    reopenCount <= 3 ? "bg-warning text-dark" :
                    "bg-danger";

                string reopenText =
                    reopenCount == 0 ? "Stable" :
                    reopenCount == 1 ? "1 Reopen" :
                    reopenCount <= 3 ? $"{reopenCount} Reopens" :
                    $"Critical ({reopenCount})";

                string statusClass =
                    i.IssueStatus == "OPEN" ? "bg-warning text-dark" :
                    i.IssueStatus == "WIP" ? "bg-info text-dark" :
                    i.IssueStatus == "FIXED" ? "bg-success" :
                    i.IssueStatus == "PASS" ? "bg-primary" :
                    i.IssueStatus == "FAIL" ? "bg-danger" :
                    i.IssueStatus == "REJECT" ? "bg-dark" :
                    "bg-secondary";

                <tr class="@(urgent ? "table-danger" : "")">
                    <td class="sticky-col col-id fw-semibold">@row</td>

                    <td class="sticky-col-2 col-issue">
                        <div class="fw-semibold">
                            @i.IssueName

                            @if (i.IsReopen)
                            {
                                <span class="badge @reopenClass reopen-badge"
                                      title="‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏Å‡πâ @reopenCount ‡∏Ñ‡∏£‡∏±‡πâ‡∏á">
                                    üîÅ @reopenText
                                </span>
                            }
                        </div>
                        <small class="text-muted">üìÖ @i.CreatedAt.ToString("dd/MM/yyyy")</small>
                    </td>

                    <td class="col-owner">
                        <span class="badge bg-light text-dark border">
                            @(i.Employee?.EmpName ?? "-")
                        </span>
                    </td>

                    <td class="col-status">
                        <span class="badge @statusClass">@i.IssueStatus</span>
                    </td>

                    <td class="col-devstatus">
                        <span class="badge 
                            @(i.DevStatus == "TODO" ? "bg-secondary" :
                              i.DevStatus == "DOING" ? "bg-info text-dark" :
                              i.DevStatus == "FIXED" ? "bg-success" :
                              i.DevStatus == "BLOCK" ? "bg-danger" : "bg-dark")">
                            @i.DevStatus
                        </span>
                    </td>

                    <td class="col-priority">
                        <span class="badge @(urgent ? "bg-danger" : "bg-secondary")">
                            @(urgent ? "üî• URGENT" : "NORMAL")
                        </span>
                    </td>

                    <td class="col-lastfix">
                        @(i.LastFixedAt?.ToString("dd/MM/yyyy HH:mm") ?? "-")
                    </td>

                    <td class="col-images">
                        @foreach (var img in i.Images)
                        {
                            <a href="@img.FilePath" target="_blank">
                                <img src="@img.FilePath" style="width:70px;height:70px;object-fit:cover;border-radius:8px;border:1px solid #ddd;" />
                            </a>
                        }
                    </td>

                    <td class="col-fiximages">
                        @foreach (var img in i.FixImages)
                        {
                            <a href="@img.FilePath" target="_blank">
                                <img src="@img.FilePath" style="width:70px;height:70px;object-fit:cover;border-radius:8px;border:2px solid #28a745;" />
                            </a>
                        }
                    </td>

                    <td class="col-action">
                        <a asp-action="Edit" asp-route-id="@i.IssueId" class="btn btn-sm btn-outline-primary me-1">‚úèÔ∏è Edit</a>

                        <form asp-action="Delete" method="post" class="d-inline" onsubmit="return confirm('Delete issue ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@i.IssueId" />
                            <button type="submit" class="btn btn-sm btn-outline-danger">üóë Delete</button>
                        </form>
                    </td>
                </tr>

                row++;
            }
            </tbody>
        </table>
    </div>
}

@section Scripts{
<script>
$(function () {
    $('#projectSelect').select2({ width:'100%' });
    $('#projectSelect').on('change', function () { $('#filterForm').submit(); });
});
</script>
}